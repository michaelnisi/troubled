<!DOCTYPE html>  <html> <head>   <title>rss.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="about.html">                 about.coffee               </a>                                           <a class="source" href="article.html">                 article.coffee               </a>                                           <a class="source" href="config.html">                 config.coffee               </a>                                           <a class="source" href="home.html">                 home.coffee               </a>                                           <a class="source" href="rss.html">                 rss.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               rss.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The rss.js module generates the RSS feed.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Require external dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jade = </span><span class="nx">require</span> <span class="s1">&#39;jade&#39;</span>
<span class="nv">blake = </span><span class="nx">require</span> <span class="s1">&#39;blake&#39;</span>
<span class="nv">markdown = </span><span class="p">(</span><span class="nx">require</span> <span class="s1">&#39;markdown&#39;</span><span class="p">).</span><span class="nx">markdown</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Get source file for input file and return a new RSS feed item populated 
with the values form the source object. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getItem = </span><span class="nf">(file, filename, paths) -&gt;</span>
  <span class="nv">src = </span><span class="nx">blake</span><span class="p">.</span><span class="nx">getSource</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">paths</span>

  <span class="nx">unless</span> <span class="nx">src</span><span class="o">?</span> 
    <span class="k">return</span>

  <span class="nv">title: </span><span class="nx">src</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">title</span>
  <span class="nv">description: </span><span class="nx">src</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">description</span>
  <span class="nv">content: </span><span class="s2">&quot;&lt;h4&gt;#{src.header.description}&lt;/h4&gt;#{markdown.toHTML src.body}&quot;</span>
  <span class="nv">link: </span><span class="nx">src</span><span class="p">.</span><span class="nx">link</span>
  <span class="nv">date: </span><span class="nx">src</span><span class="p">.</span><span class="nx">dateString</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>After reading the article file, get the RSS feed item for that article
and add it to the items array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">addItem = </span><span class="nf">(name, paths, items, callback) -&gt;</span>
  <span class="nx">blake</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">name</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
    <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

    <span class="nv">item = </span><span class="nx">getItem</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">paths</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
    <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">items</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Read the directory on the given path.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">readDir = </span><span class="nf">(path, callback) -&gt;</span>
  <span class="nx">blake</span><span class="p">.</span><span class="nx">readDir</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Iterate over names and add one item per name to the item array. Apply
callback if all items returned. Note that that this is parallel IO. We
return control when all files are read.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">addItems = </span><span class="nf">(paths, names, items, callback) -&gt;</span>
  <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span>
    <span class="nx">addItem</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">paths</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nf">(err, items) -&gt;</span>
      <span class="k">if</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">items</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Create options object for Jade with a filename property pointing to our
template path and the pretty property set to true. Compile a Jade
function with our template and our options. Create the locals object,
which is used by Jade to populate the fields in our template. Apply our
Jade function with the locals object to generate the RSS feed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compile = </span><span class="nf">(src, items, callback) -&gt;</span>
  <span class="nv">options =</span>
    <span class="nv">filename: </span><span class="nx">src</span><span class="p">.</span><span class="nx">templatePath</span>
    <span class="nv">pretty: </span><span class="kc">true</span>

  <span class="nv">rss = </span><span class="nx">jade</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">src</span><span class="p">.</span><span class="nx">template</span><span class="p">,</span> <span class="nx">options</span>

  <span class="nv">locals = </span>
    <span class="nv">items: </span><span class="nx">items</span>
    <span class="nv">channel: </span>
      <span class="nv">date: </span><span class="nx">src</span><span class="p">.</span><span class="nx">dateString</span>
      <span class="nv">title: </span><span class="nx">src</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">title</span>
      <span class="nv">description: </span><span class="nx">src</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">description</span>

  <span class="nv">result = </span><span class="nx">rss</span> <span class="nx">locals</span>

  <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Create array to store posts. Read the posts directory and iterate over the
post filenames to add each post to the items array, which we probably should
rename into posts. Apply the callback when items is completely populated.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">bake = </span><span class="nf">(src, callback) -&gt;</span>
  <span class="nv">posts = </span><span class="p">[]</span>
  
  <span class="nx">readDir</span> <span class="nx">src</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">posts</span><span class="p">,</span> <span class="nf">(err, names) -&gt;</span>
    <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

    <span class="nx">addItems</span> <span class="nx">src</span><span class="p">.</span><span class="nx">paths</span><span class="p">,</span> <span class="nx">names</span><span class="p">,</span> <span class="nx">posts</span><span class="p">,</span> <span class="nf">(err, posts) -&gt;</span>
      <span class="nx">compile</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">posts</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Export API</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span>
  <span class="nv">bake: </span><span class="nx">bake</span>
  <span class="nv">getItem: </span><span class="nx">getItem</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 