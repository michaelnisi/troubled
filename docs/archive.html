<!DOCTYPE html>  <html> <head>   <title>archive.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="about.html">                 about.coffee               </a>                                           <a class="source" href="archive.html">                 archive.coffee               </a>                                           <a class="source" href="article.html">                 article.coffee               </a>                                           <a class="source" href="config.html">                 config.coffee               </a>                                           <a class="source" href="home.html">                 home.coffee               </a>                                           <a class="source" href="likes.html">                 likes.coffee               </a>                                           <a class="source" href="rss.html">                 rss.coffee               </a>                                           <a class="source" href="tweet.html">                 tweet.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               archive.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This module generates the archive page, displaying all blog posts.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Require external dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jade = </span><span class="nx">require</span> <span class="s">&#39;jade&#39;</span>
<span class="nv">blake = </span><span class="nx">require</span> <span class="s">&#39;blake&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Require article view.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">article = </span><span class="nx">require</span> <span class="s">&#39;./article.js&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Create options object for Jade and compile template function to generate
the home page. Populate a locals object to apply the template function
with. Apply callback with resulting html result.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compile = </span><span class="nf">(src, items, callback) -&gt;</span>
  <span class="nv">options =</span>
    <span class="nv">filename: </span><span class="nx">src</span><span class="p">.</span><span class="nx">templatePath</span>
    <span class="nv">pretty: </span><span class="kc">true</span>

  <span class="nv">toArchive = </span><span class="nx">jade</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">src</span><span class="p">.</span><span class="nx">template</span><span class="p">,</span> <span class="nx">options</span>
  
  <span class="nv">hasItems = </span><span class="nx">items</span><span class="o">?</span> <span class="o">and</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">threshold = </span><span class="p">(</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="nv">locals = </span>
    <span class="nv">title: </span><span class="nx">src</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">items: </span><span class="nx">items</span>
    <span class="nv">dateString: </span><span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dateString</span>
    <span class="nv">hasItems: </span><span class="nx">hasItems</span> 
    <span class="nv">latestItem: </span><span class="k">if</span> <span class="nx">hasItems</span> <span class="k">then</span> <span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="kc">null</span>
    <span class="nv">firstColumnItems: </span><span class="nx">items</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">threshold</span>
    <span class="nv">secondColumnItems: </span><span class="nx">items</span><span class="p">.</span><span class="nx">slice</span> <span class="nx">threshold</span>

  <span class="nv">html = </span><span class="nx">toArchive</span> <span class="nx">locals</span>

  <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">html</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Read all posts and initialize an array to store the populated post items.
Iterate over the loaded files and store the resulting post item in the
items array. Sort the items by date, compile the html page with the
latest 7 posts and apply the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">bake = </span><span class="nf">(src, callback) -&gt;</span>
  <span class="nx">blake</span><span class="p">.</span><span class="nx">readFiles</span> <span class="nx">src</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">posts</span><span class="p">,</span> <span class="nf">(err, files) -&gt;</span>
    <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
    
    <span class="nv">items = </span><span class="p">[]</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">article</span><span class="p">.</span><span class="nx">getLocals</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">paths</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a, b) -&gt;</span>
      <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">time</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">time</span><span class="p">)</span><span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="nx">compile</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nf">(err, html) -&gt;</span>
      <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">html</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Export API.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.bake = </span><span class="nx">bake</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 